<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Questions</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* 기본 컨테이너 스타일 */
        .post-survey-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden; /* 내용이 삐져나가지 않도록 */
        }
        
        /* 질문 박스 스타일 */
        .question-box {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            overflow-wrap: break-word; /* 긴 텍스트 처리 */
            word-wrap: break-word; /* IE 지원 */
        }
        
        /* 옵션 컨테이너 */
        .options-container {
            margin: 15px 0;
            display: flex;
            flex-direction: column; /* 세로 배치 */
            gap: 8px; /* 옵션 간격 */
        }
        
        /* 옵션 스타일 */
        .option {
            padding: 12px;
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            transition: background-color 0.2s;
            display: flex; /* 플렉스 사용 */
            align-items: flex-start; /* 상단 정렬 */
        }
        
        .option:hover {
            background-color: #f0f7ff;
        }
        
        /* 인풋 스타일 */
        input[type="radio"], input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px; /* 텍스트와 정렬 조정 */
            flex-shrink: 0; /* 축소 방지 */
        }
        
        /* 레이블 스타일 */
        .option label {
            flex-grow: 1; /* 남은 공간 차지 */
            word-break: break-word; /* 긴 텍스트 줄바꿈 */
        }
        
        /* 텍스트에리어 스타일 */
        textarea {
            width: 100%;
            min-height: 100px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            box-sizing: border-box; /* 패딩이 너비에 포함되도록 */
        }
        
        /* 제출 버튼 스타일 */
        .submit-button {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .submit-button:hover {
            background-color: #2980b9;
        }
        
        /* 헤딩 스타일 */
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        h2 {
            color: #34495e;
            margin-bottom: 15px;
            font-size: 20px;
            line-height: 1.4;
        }
        
        /* 필수 표시 스타일 */
        .required-label {
            color: red;
            font-weight: normal;
        }
        
        /* 프로그레스 바 */
        .progress-container {
            margin-bottom: 30px;
            border-radius: 5px;
            overflow: hidden; /* 프로그레스 바가 삐져나가지 않도록 */
            background-color: #f1f1f1;
        }
        
        #progress-bar {
            height: 10px;
            background-color: #3498db;
            width: 90%;
        }
        
        /* 설명 텍스트 */
        p {
            line-height: 1.6;
            margin-bottom: 25px;
            color: #555;
        }
        
        /* Other factors 텍스트 에리어 컨테이너 */
        .textarea-container {
            margin-top: 8px;
            margin-left: 28px; /* 체크박스 + 마진과 정렬 */
        }
    </style>
</head>
<body>
    <div class="post-survey-container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <h1>Overall Evaluation Questions</h1>
        <p>Thank you for completing the individual assessments. Now we'd like to ask a few questions about your overall experience with all the images you've evaluated.</p>
        
        <!-- Influence Factors Question - Changed to checkboxes -->
        <div class="question-box">
            <h2>Which of the following factors influenced your evaluation of the 3D reconstruction quality? Choose multiple answers. <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="checkbox" id="factor2" name="influence_factors[]" value="geometry">
                    <label for="factor2">Geometry and shapes</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="factor3" name="influence_factors[]" value="texture">
                    <label for="factor3">Texture quality</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="factor5" name="influence_factors[]" value="consistency">
                    <label for="factor5">Consistency across different frames</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="factor6" name="influence_factors[]" value="other">
                    <label for="factor6">Other (please specify):</label>
                </div>
                <div class="textarea-container" id="other_factors_container" style="display: none;">
                    <textarea id="other_factors" placeholder="Please describe other factors that influenced your evaluation..."></textarea>
                </div>
            </div>
        </div>

        <!-- Artifacts Question - Changed to checkboxes -->
        <div class="question-box">
            <h2>Which of the following artifact types had impact on your evaluation? Choose multiple answers. <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="checkbox" id="artifact1" name="artifacts[]" value="blurriness">
                    <label for="artifact1">Blurriness or lack of detail</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact2" name="artifacts[]" value="flickering">
                    <label for="artifact2">Flickering or popping</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact3" name="artifacts[]" value="floating">
                    <label for="artifact3">Floating points or particles</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact4" name="artifacts[]" value="missing">
                    <label for="artifact4">Missing parts or holes</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact5" name="artifacts[]" value="distortion">
                    <label for="artifact5">Shape distortion</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact6" name="artifacts[]" value="discoloration">
                    <label for="artifact6">Color inconsistencies or discoloration</label>
                </div>
                <div class="option">
                    <input type="checkbox" id="artifact7" name="artifacts[]" value="other">
                    <label for="artifact7">Other (please specify):</label>
                </div>
                <div class="textarea-container" id="other_artifacts_container" style="display: none;">
                    <textarea id="other_artifacts" placeholder="Please describe the other artifacts..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Question about camera trajectory - Added comment field -->
        <div class="question-box">
            <h2>Was the camera trajectory sufficient to view the entire object? <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="radio" id="camera_trajectory1" name="camera_trajectory" value="1">
                    <label for="camera_trajectory1">1 - Not sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="camera_trajectory2" name="camera_trajectory" value="2">
                    <label for="camera_trajectory2">2 - Slightly sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="camera_trajectory3" name="camera_trajectory" value="3">
                    <label for="camera_trajectory3">3 - Moderately sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="camera_trajectory4" name="camera_trajectory" value="4">
                    <label for="camera_trajectory4">4 - Mostly sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="camera_trajectory5" name="camera_trajectory" value="5">
                    <label for="camera_trajectory5">5 - Very sufficient</label>
                </div>
                <div class="textarea-container">
                    <textarea id="camera_trajectory_comment" placeholder="Optional: Add any additional comments about the camera trajectory..."></textarea>
                </div>
            </div>
        </div>

        <!-- 제공된 reference image들은 오브젝트의 형태를 알아보기에 충분했나요 -->
        <div class="question-box">
            <h2>Were the provided reference images sufficient to understand the object's shape? <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="radio" id="reference_sufficiency1" name="reference_sufficiency" value="1">
                    <label for="reference_sufficiency1">1 - Not sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="reference_sufficiency2" name="reference_sufficiency" value="2">
                    <label for="reference_sufficiency2">2 - Slightly sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="reference_sufficiency3" name="reference_sufficiency" value="3">
                    <label for="reference_sufficiency3">3 - Moderately sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="reference_sufficiency4" name="reference_sufficiency" value="4">
                    <label for="reference_sufficiency4">4 - Mostly sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="reference_sufficiency5" name="reference_sufficiency" value="5">
                    <label for="reference_sufficiency5">5 - Very sufficient</label>
                </div>
                <div class="textarea-container">
                    <textarea id="reference_sufficiency_comment" placeholder="Optional: Add any additional comments about the reference images..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- 사전에 연습한 실험의 경험은 본 실험을 진행하는데 충분했나요? -->
        <!-- Practice session question - Added comment field and fixed duplicate IDs -->
        <div class="question-box">
            <h2>Was the practice session sufficient to prepare you for the actual experiment? <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="radio" id="practice_sufficiency1" name="practice_sufficiency" value="1">
                    <label for="practice_sufficiency1">1 - Not sufficient</label>
                </div>
                <div class="option">
                    <input type="radio" id="practice_sufficiency2" name="practice_sufficiency" value="2">
                    <label for="practice_sufficiency2">2 - Slightly satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="practice_sufficiency3" name="practice_sufficiency" value="3">
                    <label for="practice_sufficiency3">3 - Moderately satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="practice_sufficiency4" name="practice_sufficiency" value="4">
                    <label for="practice_sufficiency4">4 - Mostly satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="practice_sufficiency5" name="practice_sufficiency" value="5">
                    <label for="practice_sufficiency5">5 - Very satisfied</label>
                </div>
                <div class="textarea-container">
                    <textarea id="practice_sufficiency_comment" placeholder="Optional: Add any additional comments about the practice session..."></textarea>
                </div>
            </div>
        </div>

        <!-- UI 만족도 평가 -->
        <!-- UI satisfaction question - Added comment field -->
        <div class="question-box">
            <h2>How satisfied were you with the user interface of the experiment? <span class="required-label">*</span></h2>
            <div class="options-container">
                <div class="option">
                    <input type="radio" id="ui_satisfaction1" name="ui_satisfaction" value="1">
                    <label for="ui_satisfaction1">1 - Not satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="ui_satisfaction2" name="ui_satisfaction" value="2">
                    <label for="ui_satisfaction2">2 - Slightly satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="ui_satisfaction3" name="ui_satisfaction" value="3">
                    <label for="ui_satisfaction3">3 - Moderately satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="ui_satisfaction4" name="ui_satisfaction" value="4">
                    <label for="ui_satisfaction4">4 - Mostly satisfied</label>
                </div>
                <div class="option">
                    <input type="radio" id="ui_satisfaction5" name="ui_satisfaction" value="5">
                    <label for="ui_satisfaction5">5 - Very satisfied</label>
                </div>
                <div class="textarea-container">
                    <textarea id="ui_satisfaction_comment" placeholder="Optional: Add any additional comments about the user interface..."></textarea>
                </div>
            </div>
        </div>

        <!-- Additional Comments -->
        <div class="question-box">
            <h2>Do you have any additional comments or observations about the 3D reconstructions?</h2>
            <textarea id="additional_comments" placeholder="Share your thoughts, comments, or observations..."></textarea>
        </div>

        <!-- Overall Experiment Feedback -->
        <div class="question-box">
            <h2>Do you have any feedback about the experiment itself?</h2>
            <p style="font-size: 14px; font-style: italic; margin-bottom: 15px;">
                This could include comments about the clarity of instructions, usability of the interface, 
                experiment length, or any suggestions for improvements.
            </p>
            <textarea id="experiment_feedback" placeholder="Share your feedback about the experiment process, interface, or any other aspects..."></textarea>
        </div>
        
        <button class="submit-button" onclick="submitFinalSurvey()">Complete Evaluation</button>
    </div>
    
    <script>
        // 이전 설문 데이터 가져오기 - 오류 처리 추가
        let surveyAnswers = {}; 
        try {
            const savedData = localStorage.getItem("surveyAnswers");
            if (savedData) {
                surveyAnswers = JSON.parse(savedData);
                console.log("Successfully loaded previous answers");
            } else {
                console.warn("No previous answers found in localStorage");
            }
        } catch (error) {
            console.error("Error loading previous answers:", error);
        }
        
        // "Other" 옵션 처리
        document.querySelector('input[id="factor6"]').addEventListener("change", function() {
            document.getElementById("other_factors_container").style.display = 
                this.checked ? "block" : "none";
        });
        
        document.getElementById("artifact7").addEventListener("change", function() {
            document.getElementById("other_artifacts_container").style.display = 
                this.checked ? "block" : "none";
        });
        
        // Update for checkbox handling
        document.querySelector('input[id="factor6"]').addEventListener("change", function() {
            document.getElementById("other_factors_container").style.display = 
                this.checked ? "block" : "none";
        });

        document.getElementById("artifact7").addEventListener("change", function() {
            document.getElementById("other_artifacts_container").style.display = 
                this.checked ? "block" : "none";
        });

        function submitFinalSurvey() {
            // Collect checkboxes for influence factors
            const influenceFactors = Array.from(
                document.querySelectorAll('input[name="influence_factors[]"]:checked')
            ).map(input => input.value);
            
            // Collect checkboxes for artifacts
            const artifactTypes = Array.from(
                document.querySelectorAll('input[name="artifacts[]"]:checked')
            ).map(input => input.value);
            
            // Validation
            if (influenceFactors.length === 0) {
                alert("Please select at least one factor that influenced your evaluation.");
                return;
            }
            
            if (artifactTypes.length === 0) {
                alert("Please select at least one artifact type that had impact.");
                return;
            }
            
            // Additional validations for required radio buttons
            if (!document.querySelector('input[name="camera_trajectory"]:checked')) {
                alert("Please answer the question about camera trajectory.");
                return;
            }
            
            if (!document.querySelector('input[name="reference_sufficiency"]:checked')) {
                alert("Please answer the question about reference images.");
                return;
            }
            
            if (!document.querySelector('input[name="practice_sufficiency"]:checked')) {
                alert("Please answer the question about practice session.");
                return;
            }
            
            if (!document.querySelector('input[name="ui_satisfaction"]:checked')) {
                alert("Please answer the question about UI satisfaction.");
                return;
            }
            
            try {
                // Get other form values
                const otherFactorsText = document.getElementById("other_factors").value;
                const otherArtifactsText = document.getElementById("other_artifacts").value;
                const additionalComments = document.getElementById("additional_comments").value;
                const experimentFeedback = document.getElementById("experiment_feedback").value;
                
                // Collect all optional comment fields
                const cameraTrajectoryComment = document.getElementById("camera_trajectory_comment").value;
                const referenceComment = document.getElementById("reference_sufficiency_comment").value;
                const practiceComment = document.getElementById("practice_sufficiency_comment").value;
                const uiComment = document.getElementById("ui_satisfaction_comment").value;
                
                // Create final survey data
                const finalSurveyData = {
                    influenceFactors: influenceFactors,
                    otherFactors: otherFactorsText,
                    artifactTypes: artifactTypes,
                    otherArtifacts: otherArtifactsText,
                    cameraTrajectory: {
                        rating: document.querySelector('input[name="camera_trajectory"]:checked').value,
                        comment: cameraTrajectoryComment
                    },
                    referenceImages: {
                        rating: document.querySelector('input[name="reference_sufficiency"]:checked').value,
                        comment: referenceComment
                    },
                    practiceSession: {
                        rating: document.querySelector('input[name="practice_sufficiency"]:checked').value,
                        comment: practiceComment
                    },
                    uiSatisfaction: {
                        rating: document.querySelector('input[name="ui_satisfaction"]:checked').value,
                        comment: uiComment
                    },
                    additionalComments: additionalComments,
                    experimentFeedback: experimentFeedback,
                    completedAt: new Date().toISOString()
                };
                
                // 기존 설문 데이터와 병합
                if (!surveyAnswers) surveyAnswers = {};
                surveyAnswers.finalSurvey = finalSurveyData;
                
                // 로컬 스토리지에 저장 시도
                try {
                    localStorage.setItem("surveyAnswers", JSON.stringify(surveyAnswers));
                    console.log("Final survey responses saved to localStorage:", finalSurveyData);
                } catch (storageError) {
                    console.warn("Could not save to localStorage:", storageError);
                }
                
                // 파일 다운로드 구현
                const participantName = surveyAnswers.participantInfo ? 
                                      surveyAnswers.participantInfo.name || "participant" : 
                                      "participant";
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                const filename = `survey_responses_${participantName}_${timestamp}.json`;
                
                // JSON 데이터를 Blob으로 변환
                const jsonData = JSON.stringify(surveyAnswers, null, 2);
                const blob = new Blob([jsonData], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                // 다운로드 링크 생성 및 클릭
                const downloadLink = document.createElement("a");
                downloadLink.href = url;
                downloadLink.download = filename;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                
                // 리소스 정리
                setTimeout(() => {
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    // 완료 메시지 후 이동
                    alert("Thank you for completing the evaluation! Your responses have been downloaded automatically.");
                    window.location.href = "end.html";
                }, 100);
                
            } catch (error) {
                console.error("Error in submit process:", error);
                alert("There was a problem processing your responses. Please try again.");
            }
        }
    </script>
</body>
</html>